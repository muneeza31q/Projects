/*8/30/2022*/

CREATE TABLE diag9both AS
SELECT *
FROM diagpython
WHERE DIAGNOSIS_CD_TYPE='ICD10' AND DIAGNOSIS_STATUS = 'Diagnosis of' AND diagdate1 >= '2020-01-01'
/*GROUP BY PTID*/
/*ORDER BY PTID DESC*/
/*HAVING COUNT (*)>1*/
;
SELECT *
FROM diag9both
/*GROUP BY ENCID*/
HAVING COUNT (*)>1
ORDER BY PTID DESC
;
/*check duplicate*/
SELECT *, COUNT(*) AS Count
FROM diag9both
WHERE ENCID NOT LIKE ''
GROUP BY PTID, ENCID, DIAG_DATE, DIAG_TIME, DIAGNOSIS_CD, POA, ADMITTING_DIAGNOSIS, DISCHARGE_DIAGNOSIS, PRIMARY_DIAGNOSIS, PROBLEM_LIST, SOURCEID
HAVING COUNT(*)>1
ORDER BY PTID DESC
;
ALTER TABLE diag9both
RENAME TO diagnosis9
;
/*looking at cov_20210916_lab9*/
SELECT *, COUNT(*)
FROM cov_20210916_lab9_postive
;
SELECT *, COUNT(*)
FROM cov_20210916_lab9_postive
GROUP BY PTID 
HAVING COUNT (*)>1
;
CREATE TABLE lab9both AS
SELECT * /*, COUNT(*)*/
FROM lab9python
WHERE TEST_NAME = 'SARS CORONAVIRUS 2 RNA (COVID-19).RESPIRATORY' AND RESULT_DATE1 >= '2020-01-01' 
AND TEST_RESULT NOT LIKE '%DETECT%' AND TEST_RESULT NOT LIKE '%PRESUMPTIVE%' AND TEST_RESULT NOT LIKE 'COVID-19 POSITIVESARS COV-2 RNA VIRAL TESTING PERFORMED USING THE ABBOTT ID NOW WHICH HAS BEEN GRANTED EMERGENCY USE AUTHORIZATION BY THE FEDERAL DRUG ADMINISTRATION'
AND TEST_RESULT NOT LIKE 'POSITIVE FOR 2019-NCOV' AND TEST_RESULT NOT LIKE '%NO.%' AND TEST_RESULT NOT LIKE 'NEGATIVE [ REFERENCE RANGE NEGATIVE ]' AND TEST_RESULT NOT LIKE 'POSITIVE FOR COVID19 (SARS COV2) BY PCR.' AND TEST_RESULT NOT LIKE 'NEGATIVE FOR COVID19 (SARS COV2) BY PCR.'
AND TEST_RESULT NOT LIKE 'POSITIVE [ REFERENCE RANGE NEGATIVE ]' AND TEST_RESULT NOT LIKE 'THIS IS A NEGATIVE RESULT. LABORATORY TESTING ALONE CANNOT RULE OUT INFECTION; PARTICULARLY IN THE PRESENCE OF CLINICAL RISK FACTORS SUCH AS SYMPTOMS OR EXPOSURE HISTORY.'
AND TEST_RESULT NOT LIKE 'ABNORMAL' AND TEST_RESULT NOT LIKE '%YES.%' AND TEST_RESULT NOT LIKE 'NOT DECTETED' AND TEST_RESULT NOT LIKE 'POSITIVE FOR COVID19 (SARS COV2) BY PCR.(*)' AND TEST_RESULT NOT LIKE 'Y' AND TEST_RESULT NOT LIKE 'YES' AND TEST_RESULT NOT LIKE 'NO'
;
/*check duplicates*/
SELECT *, COUNT(*) AS Count
FROM lab9both
/*WHERE ENCID NOT LIKE '' AND TEST_CODE NOT LIKE ''*/
GROUP BY PTID, ENCID,TEST_CODE, ORDER_DATE, ORDER_TIME, COLLECTED_DATE, COLLECTED_TIME, RESULT_DATE, RESULT_TIME, TEST_RESULT, CORONAVIRUS, SARS, MERS, COVID, PCR, ANTIBODY, ANTIGEN, Interested, POSITIVE
HAVING COUNT(*)>1
ORDER BY PTID DESC
;
delete from lab9both
where rowid not in (select min(rowid)
from lab9both
group by PTID, ENCID,TEST_CODE, ORDER_DATE, ORDER_TIME, COLLECTED_DATE, COLLECTED_TIME, RESULT_DATE, RESULT_TIME, TEST_RESULT, CORONAVIRUS, SARS, MERS, COVID, PCR, ANTIBODY, ANTIGEN, Interested, POSITIVE)
;
ALTER TABLE lab9both
RENAME to lab9;
/*save data (w/ no duplicates) as new table*/
CREATE TABLE lab9 AS
SELECT DISTINCT lab9both.* FROM lab9both 
WHERE RESULT_DATE1 >= '2020-01-01' 
GROUP BY PTID, ENCID,TEST_CODE, ORDER_DATE, ORDER_TIME, COLLECTED_DATE, COLLECTED_TIME, RESULT_DATE, RESULT_TIME, TEST_RESULT, CORONAVIRUS, SARS, MERS, COVID, PCR, ANTIBODY, ANTIGEN, Interested, POSITIVE;

/*check duplicates*/
SELECT *, COUNT(*) AS Count
FROM lab9
GROUP BY PTID, ENCID,TEST_CODE, ORDER_DATE, ORDER_TIME, COLLECTED_DATE, COLLECTED_TIME, RESULT_DATE, RESULT_TIME, TEST_RESULT, CORONAVIRUS, SARS, MERS, COVID, PCR, ANTIBODY, ANTIGEN, Interested, POSITIVE
HAVING COUNT(*)>1
ORDER BY PTID DESC
;



/*8/30/2022*/
/*step 1: join 2 tables where PTID is equal*/
/*join 2 tables*/
CREATE TABLE covid1 AS
SELECT *
FROM lab9 JOIN diagnosis9
WHERE lab9.PTID=diagnosis9.PTID;

/*Check duplicates */
SELECT *, COUNT(*) AS Count
FROM covid1
GROUP BY PTID, ENCID, TEST_CODE, ORDER_DATE, ORDER_TIME, COLLECTED_DATE, COLLECTED_TIME, RESULT_DATE, RESULT_TIME, TEST_RESULT, CORONAVIRUS, SARS, MERS, COVID, PCR, ANTIBODY, ANTIGEN, Interested, POSITIVE,
PTID, ENCID_1, DIAG_DATE, DIAG_TIME, DIAGNOSIS_CD, POA, ADMITTING_DIAGNOSIS, DISCHARGE_DIAGNOSIS, PRIMARY_DIAGNOSIS, PROBLEM_LIST, SOURCEID
/*GROUP BY PTID, ENCID, RESULT_DATE1, RESULT_TIME, PTID, ENCID, diagdate1, DIAG_TIME, DIAGNOSIS_CD*/
HAVING COUNT(*)>1
ORDER BY PTID ;

/*ALTER TABLE covid1 AS
RENAME COLUMN ENCID:1 TO ENCID_1;*/

/*step 2: fix result time to starndard time 0:00:00 to 00:00:00 */
CREATE TABLE covid2 AS
SELECT *,
RESULT_DATE1, iif(length(RESULT_TIME)=7, '0', '') || RESULT_TIME AS RESULT_TIME,
diagdate1, iif(length(DIAG_TIME)=7, '0', '') || DIAG_TIME AS DIAG_TIME
FROM covid1;

/*step 3: fix result date to 7 days */
CREATE TABLE covid3 AS
SELECT *
FROM covid2
WHERE covid2.RESULT_DATE1 || ' ' ||covid2.RESULT_TIME_1 BETWEEN date(covid2.diagdate1, '-7 day') || ' ' || covid2.DIAG_TIME_1 AND covid2.diagdate1 || ' ' || covid2.DIAG_TIME_1
;

/*step 4: using covid3, when result date is same, time must be right*/
CREATE TABLE covid4 AS
SELECT * 
FROM covid3 /*where RESULT_DATE1=diagdate1 and TIME(RESULT_TIME_1)> TIME(DIAG_TIME_1)*/;
SELECT RESULT_DATE1, RESULT_TIME_1, diagdate1, DIAG_TIME_1
FROM covid4 WHERE RESULT_DATE1=diagdate1 AND RESULT_TIME_1 > DIAG_TIME_1;

/*Step 5: delete if result time > diag time*/
CREATE TABLE covid5 AS
SELECT * 
FROM covid4 /*where RESULT_DATE1=diagdate1 and TIME(RESULT_TIME_1)> TIME(DIAG_TIME_1)*/;
SELECT RESULT_DATE1, RESULT_TIME_1, diagdate1, DIAG_TIME_1
FROM covid5 WHERE RESULT_DATE1=diagdate1 AND RESULT_TIME_1 > DIAG_TIME_1;
delete from covid5
where RESULT_DATE1=diagdate1 AND RESULT_DATE1 || ' ' || TIME(RESULT_TIME_1) > diagdate1 || ' ' || TIME(DIAG_TIME_1);


/*Step 6: group by ptid and diagnosis_cd and max result date*/
CREATE TABLE covid6 AS
SELECT *
FROM covid5
group by PTID || DIAGNOSIS_CD 
HAVING MAX(RESULT_DATE1) /*AND MAX(RESULT_TIME_1)*/;

CREATE TABLE covid6TRIAL AS
SELECT *
FROM covid5
group by PTID || DIAGNOSIS_CD 
HAVING MAX(RESULT_DATE1) and MAX(RESULT_TIME_1);

SELECT PTID, ENCID, RESULT_DATE1, RESULT_TIME_1, ENCID_1, diagdate1, DIAG_TIME_1, TEST_RESULT, DIAGNOSIS_CD
from covid6 where PTID='PT575390699' ORDER BY RESULT_DATE1;

/*looking at ptid with multiple encounters*/
SELECT *
FROM covid6
WHERE PTID IN (
SELECT PTID
FROM covid6
GROUP BY PTID
HAVING SUM(CASE WHEN TEST_RESULT = 'POSITIVE' THEN 1 ELSE 0 END) > 0
AND 
SUM(CASE WHEN TEST_RESULT = 'NEGATIVE' THEN 1 ELSE 0 END) > 0 
ORDER BY RESULT_DATE1
); 
/*Check duplicates */
SELECT *, COUNT(*) AS Count
FROM covid6
GROUP BY PTID, ENCID, TEST_CODE, ORDER_DATE, ORDER_TIME, COLLECTED_DATE, COLLECTED_TIME, RESULT_DATE, RESULT_TIME, TEST_RESULT, CORONAVIRUS, SARS, MERS, COVID, PCR, ANTIBODY, ANTIGEN, Interested, POSITIVE,
PTID, ENCID_1, DIAG_DATE, DIAG_TIME, DIAGNOSIS_CD, POA, ADMITTING_DIAGNOSIS, DISCHARGE_DIAGNOSIS, PRIMARY_DIAGNOSIS, PROBLEM_LIST, SOURCEID,RESULT_DATE1, DIAG_TIME_1
/*GROUP BY PTID, ENCID, RESULT_DATE1, RESULT_TIME, PTID, ENCID, diagdate1, DIAG_TIME, DIAGNOSIS_CD*/
HAVING COUNT(*)>1
ORDER BY PTID ;

/*9/06/22*/
/*step 7: calculations of TP, TN, FP, FN but keep these original tables*/
CREATE TABLE TP AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from 
(
select *
,count(case when DIAGNOSIS_CD='U071' and TEST_RESULT = 'POSITIVE' then 1 end) over (partition by PTID,TEST_RESULT) as cnt
from covid6 

) covid6
group by PTID, RESULT_DATE1, RESULT_TIME_1
having cnt > 0 /*and TEST_RESULT = 'POSITIVE'*/
ORDER BY PTID;


CREATE TABLE FP AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,diagdate1
,DIAGNOSIS_CD
,count(*) as 'Count'
from 
(
select *
,count(case when DIAGNOSIS_CD='U071' and TEST_RESULT = 'NEGATIVE' then 1 end) over (partition by PTID,TEST_RESULT) as cnt
from covid6 

) covid6
group by PTID, RESULT_DATE1, RESULT_TIME_1
having cnt > 0 and TEST_RESULT = 'NEGATIVE'
ORDER BY PTID;




CREATE TABLE FN AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from 
(
select *
,count(case when DIAGNOSIS_CD<>'U071' and TEST_RESULT = 'POSITIVE' then 1 end) over (partition by PTID,TEST_RESULT) as cnt
from covid6 

) covid6
group by PTID, RESULT_DATE1, RESULT_TIME_1
having cnt > 0 and TEST_RESULT = 'POSITIVE'
ORDER BY PTID;

CREATE TABLE TN AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,diagdate1
,DIAGNOSIS_CD
,count(*) as 'Count'
from 
(
select *
,count(case when DIAGNOSIS_CD<>'U071' and TEST_RESULT = 'NEGATIVE' then 1 end) over (partition by PTID,TEST_RESULT) as cnt
from covid6 

) covid6
group by PTID, TEST_RESULT
having cnt > 0 and TEST_RESULT = 'NEGATIVE'
ORDER BY PTID;

SELECT *, COUNT(*) as 'Count'
FROM (
select *
,count(case when DIAGNOSIS_CD='U071' and TEST_RESULT = 'POSITIVE' then 1 end) over (partition by PTID,TEST_RESULT) as cnt
from covid6 

) covid6
GROUP BY PTID, RESULT_DATE1, RESULT_TIME_1
having cnt > 1
ORDER BY PTID;
/*DID NOT WORK step 7: find calculations of TP, TN, FP, FN
CREATE TABLE covid7TRIAL AS
SELECT PTID, ENCID, RESULT_DATE1, RESULT_TIME_1, TEST_RESULT, ENCID_1, diagdate1, DIAG_TIME_1, DIAGNOSIS_CD
FROM covid6
WHERE TEST_RESULT='POSITIVE' AND DIAGNOSIS_CD like '%U071%' 
/*group by PTID /*|| DIAGNOSIS_CD*/
/*ORDER BY PTID ASC;*/


/*9/13/22*/
/*apply strict def of U071 BEST*/
CREATE TABLE Def1_TP AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(DIAGNOSIS_CD) /*over (partition by PTID,DIAGNOSIS_CD)*/ Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT = 'POSITIVE' AND DIAGNOSIS_CD='U071'
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM (DIAGNOSIS_CD='U071')> 0 
ORDER BY PTID;

CREATE TABLE Def1_FN AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,COUNT(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT = 'POSITIVE' AND DIAGNOSIS_CD<>'U071'
/*where EXISTS( SELECT 1 FROM covid6 WHERE DIAGNOSIS_CD NOT in ('U071') AND TEST_RESULT='POSITIVE' )*/
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM(DIAGNOSIS_CD NOT IN ('U071')) >0
ORDER BY PTID;

CREATE TABLE FN1trial AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'POSITIVE' AND DIAGNOSIS_CD<>'U071'
group by RESULT_DATE1, RESULT_TIME_1, PTID || DIAGNOSIS_CD
ORDER BY PTID;

CREATE TABLE Def1_FP AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND DIAGNOSIS_CD='U071'
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM(DIAGNOSIS_CD ='U071') >0
ORDER BY PTID;

CREATE TABLE FP1trial AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND DIAGNOSIS_CD='U071'
group by RESULT_DATE1, RESULT_TIME_1, PTID || DIAGNOSIS_CD
ORDER BY PTID;


CREATE TABLE Def1_TN AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND DIAGNOSIS_CD<>'U071'
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM(DIAGNOSIS_CD ='U071') =0
ORDER BY PTID;

CREATE TABLE TN1trial AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND DIAGNOSIS_CD<>'U071'
group by RESULT_DATE1, RESULT_TIME_1, PTID || DIAGNOSIS_CD
ORDER BY PTID;




/* 9/20/2022 */
/*apply strict def of U071 BEST */
CREATE TABLE Def1_TP AS
select PTID
/*,TEST_RESULT */
,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD */
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT = 'POSITIVE' /*AND DIAGNOSIS_CD='U071'*/
GROUP BY PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM(DIAGNOSIS_CD = 'U071') >0
ORDER BY PTID;

CREATE TABLE Def1_FN AS
select PTID
,RESULT_DATE1
,RESULT_TIME_1
,COUNT(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT = 'POSITIVE' 
/*where EXISTS( SELECT 1 FROM covid6 WHERE DIAGNOSIS_CD NOT in ('U071') AND TEST_RESULT='POSITIVE' )*/
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM(DIAGNOSIS_CD ='U071') =0
ORDER BY PTID;

CREATE TABLE ABC AS
select PTID
/*,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD */
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD) 
from diagnosis9
/*where TEST_RESULT = 'POSITIVE' AND DIAGNOSIS_CD='U071'*/
GROUP BY PTID
HAVING SUM(DIAGNOSIS_CD = 'U071') >0
ORDER BY PTID;

CREATE TABLE Def1_FP AS
select PTID
,RESULT_DATE1
,RESULT_TIME_1
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND DIAGNOSIS_CD='U071'
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM(DIAGNOSIS_CD ='U071') >0
ORDER BY PTID;

CREATE TABLE Def1_TN AS
select PTID
,RESULT_DATE1
,RESULT_TIME_1
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND DIAGNOSIS_CD<>'U071'
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM(DIAGNOSIS_CD ='U071') =0
ORDER BY PTID;

CREATE TABLE U071patient AS
select PTID
,DIAGNOSIS_CD 
,DIAG_DATE
,DIAG_TIME 
from diagnosis9
where DIAGNOSIS_CD='U071'
ORDER BY PTID;

CREATE TABLE PCRpluspatient AS
select PTID
,TEST_RESULT 
,RESULT_DATE
,RESULT_TIME
from lab9
where TEST_RESULT = 'POSITIVE' 
ORDER BY PTID;

CREATE TABLE PositiveU071 AS
select U071patient.PTID
from U071patient, PCRpluspatient
where U071patient.PTID=PCRpluspatient.PTID
group by U071patient.PTID;


CREATE TABLE XYZ AS
select PTID
,TEST_RESULT 
/*,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD 
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD) */
from lab9
where TEST_RESULT = 'POSITIVE' 
/*GROUP BY PTID
HAVING SUM(DIAGNOSIS_CD = 'U071') >0 */
ORDER BY PTID;



CREATE TABLE Def1_FN AS
select PTID
/* ,TEST_RESULT */
,RESULT_DATE1
,RESULT_TIME_1
/* ,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD */
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT='POSITIVE'
/*where EXISTS( SELECT DIAGNOSIS_CD <> 'U071' FROM covid6 WHERE DIAGNOSIS_CD NOT in ('U071') AND TEST_RESULT='POSITIVE' )*/
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM(DIAGNOSIS_CD = 'U071') = 0
ORDER BY PTID;

CREATE TABLE FN1trial AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'POSITIVE' AND DIAGNOSIS_CD<>'U071'
group by RESULT_DATE1, RESULT_TIME_1, PTID || DIAGNOSIS_CD
ORDER BY PTID;

CREATE TABLE Def1_FP AS
select PTID
/* ,TEST_RESULT */
,RESULT_DATE1
,RESULT_TIME_1
/* ,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD */
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT = 'NEGATIVE' /*AND DIAGNOSIS_CD='U071'
/*where EXISTS( SELECT 1 FROM covid6 WHERE DIAGNOSIS_CD NOT in ('U071') AND TEST_RESULT='POSITIVE' )*/
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM(DIAGNOSIS_CD ='U071') > 0
ORDER BY PTID;
/*delete from Def1_FP
where DIAGNOSIS_CD = 'U071'; */

CREATE TABLE FP1trial AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND DIAGNOSIS_CD='U071'
group by RESULT_DATE1, RESULT_TIME_1, PTID || DIAGNOSIS_CD
ORDER BY PTID;


CREATE TABLE Def1_TN AS
select PTID
/* ,TEST_RESULT */
,RESULT_DATE1
,RESULT_TIME_1
/* ,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD */
,count(DIAGNOSIS_CD) Count
/*,count(*) as 'Count'*/
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6 
WHERE TEST_RESULT='NEGATIVE'
/*where TEST_RESULT = 'NEGATIVE' */
/*where EXISTS (SELECT 1 FROM covid6 where DIAGNOSIS_CD NOT IN ('U071') AND TEST_RESULT='NEGATIVE')*/
group by PTID, RESULT_DATE1, RESULT_TIME_1
HAVING SUM (DIAGNOSIS_CD ='U071') = 0
ORDER BY PTID;

CREATE TABLE TN1trial AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND DIAGNOSIS_CD<>'U071'
group by RESULT_DATE1, RESULT_TIME_1, PTID || DIAGNOSIS_CD
ORDER BY PTID;


select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
from covid6 where PTID='PT734838499';

/*CREATE TABLE TRIAL AS */
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6 WHERE TEST_RESULT='POSITIVE' OR TEST_RESULT='NEGATIVE' group by PTID, RESULT_DATE1, RESULT_TIME_1 ORDER BY PTID ;

/*SELECT * /*Def1_TN."Person", Def1_TN."Package ID", Def1_TN."Date" 
FROM Def1_TN LEFT JOIN TRIAL ON TRIAL.PTID = Def1_TN.PTID
WHERE (',' || Def1_TN.DIAGNOSIS_CD || ',') NOT LIKE ('%,' || COALESCE(TRIAL.DIAGNOSIS_CD,'') || ',%');*/


/*9/27/2022*/
CREATE TABLE ABC AS
select PTID
/*,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD */
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD) 
from diagnosis9
/*where TEST_RESULT = 'POSITIVE' AND DIAGNOSIS_CD='U071'*/
GROUP BY PTID
HAVING SUM(DIAGNOSIS_CD = 'U071') >0
ORDER BY PTID;

CREATE TABLE ABC_1 AS
select PTID
/*,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD */
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD) 
from diagnosis9
/*where TEST_RESULT = 'POSITIVE' AND DIAGNOSIS_CD='U071'*/
GROUP BY PTID
HAVING SUM(DIAGNOSIS_CD = 'U071') =0
ORDER BY PTID;


CREATE TABLE U071patient AS
select PTID
,DIAGNOSIS_CD 
,DIAG_DATE
,DIAG_TIME 
from diagnosis9
where DIAGNOSIS_CD='U071'
ORDER BY PTID;

CREATE TABLE PCRpluspatient AS
select PTID
,TEST_RESULT 
,RESULT_DATE
,RESULT_TIME
from lab9
where TEST_RESULT = 'POSITIVE' 
ORDER BY PTID;

CREATE TABLE PositiveU071 AS
select U071patient.PTID
from U071patient, PCRpluspatient
where U071patient.PTID=PCRpluspatient.PTID
group by U071patient.PTID;

/*TRIAL FOR lab9python*/
CREATE TABLE U071patient AS
select PTID
,DIAGNOSIS_CD 
,DIAG_DATE
,DIAG_TIME 
from diagnosis9
where DIAGNOSIS_CD='U071'
ORDER BY PTID;

CREATE TABLE PCRpluspatienttrial AS
select PTID
,TEST_RESULT 
,RESULT_DATE
,RESULT_TIME
from lab9python
where TEST_RESULT = 'POSITIVE' 
ORDER BY PTID;

CREATE TABLE PositiveU071trial AS
select PCRpluspatienttrial.PTID
from U071patient, PCRpluspatienttrial
where U071patient.PTID=PCRpluspatienttrial.PTID
group by U071patient.PTID;


CREATE TABLE XYZ AS
select PTID
,TEST_RESULT 
/*,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD 
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD) */
from lab9
where TEST_RESULT = 'POSITIVE' 
/*GROUP BY PTID
HAVING SUM(DIAGNOSIS_CD = 'U071') >0 */
ORDER BY PTID;

CREATE TABLE XYZ_1 AS
select PTID
,TEST_RESULT 
/*,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD 
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD) */
from lab9
where TEST_RESULT = 'NEGATIVE' 
/*GROUP BY PTID
HAVING SUM(DIAGNOSIS_CD = 'U071') >0 */
ORDER BY PTID;














/*10/04/22*/
/*Definition 2: U071 with code sets*/
CREATE TABLE ABC_Def2 AS
select PTID
/*,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD */
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD) 
from diagnosis9
/*where TEST_RESULT = 'POSITIVE' AND DIAGNOSIS_CD='U071'*/
GROUP BY PTID
/*HAVING SUM((DIAGNOSIS_CD IN ('U071') OR DIAGNOSIS_CD IN ('Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))) >0 */
HAVING SUM((DIAGNOSIS_CD IN ('U071','Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))) >0
ORDER BY PTID;


CREATE TABLE ABC_1_Def2 AS
select PTID
/*,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD */
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD) 
from diagnosis9
/*where TEST_RESULT = 'POSITIVE' AND DIAGNOSIS_CD='U071'*/
GROUP BY PTID
/*HAVING SUM((DIAGNOSIS_CD IN ('U071') OR DIAGNOSIS_CD IN ('Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))) =0 */
HAVING SUM((DIAGNOSIS_CD IN ('U071','Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))) =0
ORDER BY PTID;


CREATE TABLE U071patientDef2 AS
select PTID
,DIAGNOSIS_CD 
/*,DIAG_DATE
,DIAG_TIME */
,GROUP_CONCAT(DIAGNOSIS_CD)
,Count (DIAGNOSIS_CD) count
from diagnosis9
where (DIAGNOSIS_CD IN ('U071') OR DIAGNOSIS_CD IN ('Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))
GROUP BY PTID
HAVING COUNT>0
ORDER BY PTID;

CREATE TABLE PCRpluspatient AS
select PTID
,TEST_RESULT 
/*,RESULT_DATE
,RESULT_TIME */
from lab9
where TEST_RESULT = 'POSITIVE' 
ORDER BY PTID;

CREATE TABLE PositiveU071Def2 AS
select U071patientDef2.PTID
from U071patientDef2, PCRpluspatient
where U071patientDef2.PTID=PCRpluspatient.PTID
group by U071patientDef2.PTID;

CREATE TABLE XYZ_Def2 AS
select PTID
,TEST_RESULT 
/*,RESULT_DATE1
,RESULT_TIME_1
/*,diagdate1
,DIAG_TIME_1 
,DIAGNOSIS_CD 
,count(DIAGNOSIS_CD) Count
,GROUP_CONCAT(DIAGNOSIS_CD) */
from lab9
where TEST_RESULT = 'POSITIVE' 
/*GROUP BY PTID
HAVING SUM(DIAGNOSIS_CD = 'U071') >0 */
ORDER BY PTID;

CREATE TABLE combined AS
SELECT *, RESULT_DATE1, iif(length(RESULT_TIME)=7, '0', '') || RESULT_TIME AS RESULT_TIME,
diagdate1, iif(length(DIAG_TIME)=7, '0', '') || DIAG_TIME AS DIAG_TIME
FROM diagpython, lab9python where diagpython.PTID= lab9python.PTID;

SELECT PTID/*, GROUP_CONCAT(DIAGNOSIS_CD), Count(*) */
FROM combined where RESULT_DATE1 >= '2020-01-01'
/*and DIAGNOSIS_CD_TYPE='ICD10' 
AND TEST_RESULT='NEGATIVE' /*OR TEST_RESULT='POSITIVE' */
AND RESULT_DATE1=diagdate1 AND RESULT_TIME_1 < DIAG_TIME_1
/*GROUP BY PTID
order by PTID*/;

/*10/01*/
SELECT PTID, GROUP_CONCAT(DIAGNOSIS_CD), Count(*) 
FROM covid2 where /*RESULT_DATE1 >= '2020-01-01' 
AND TEST_RESULT='POSITIVE' /*OR TEST_RESULT='NEGATIVE' 
 AND */RESULT_DATE1<diagdate1 AND RESULT_TIME_1 < DIAG_TIME_1
/*AND RESULT_DATE1 || ' ' ||RESULT_TIME_1 BETWEEN date(diagdate1, '-7 day') || ' ' || DIAG_TIME_1 AND diagdate1 || ' ' || DIAG_TIME_1*/
GROUP BY PTID
order by PTID;






/*10/04/22*/
CREATE TABLE Def2_TP AS
select PTID
,count(DIAGNOSIS_CD) /*over (partition by PTID,DIAGNOSIS_CD)*/ Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT='POSITIVE' AND DIAGNOSIS_CD IN ('U071','O985','Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159')
group by PTID
HAVING SUM (DIAGNOSIS_CD IN ('U071','O985','Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))> 0 
ORDER BY PTID;

CREATE TABLE Def2_FP AS
select PTID
,count(DIAGNOSIS_CD) /*over (partition by PTID,DIAGNOSIS_CD)*/ Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT='NEGATIVE' AND DIAGNOSIS_CD IN ('U071','O985','Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159')
group by PTID
HAVING SUM (DIAGNOSIS_CD IN ('U071','O985','Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))> 0 
ORDER BY PTID;

CREATE TABLE Def2_FN AS
select PTID
,RESULT_DATE1
,RESULT_TIME_1
,count(DIAGNOSIS_CD) /*over (partition by PTID,DIAGNOSIS_CD)*/ Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT='POSITIVE' /*AND DIAGNOSIS_CD NOT IN ('U071','O985','Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159')*/
group by PTID
HAVING SUM (DIAGNOSIS_CD IN ('U071','O985','Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))= 0 
ORDER BY PTID;


CREATE TABLE Def2_TN AS
select PTID
,count(DIAGNOSIS_CD) /*over (partition by PTID,DIAGNOSIS_CD)*/ Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid6
where TEST_RESULT='NEGATIVE' AND DIAGNOSIS_CD NOT IN ('U071', 'O985','Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159')
group by PTID
HAVING SUM (DIAGNOSIS_CD IN ('U071', 'O985', 'Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))= 0 
ORDER BY PTID;

CREATE TABLE TRIALLooseDef2_TN AS
select PTID
,count(DIAGNOSIS_CD) /*over (partition by PTID,DIAGNOSIS_CD)*/ Count
,GROUP_CONCAT(DIAGNOSIS_CD)
from covid1
where TEST_RESULT='POSITIVE' 
group by PTID
ORDER BY PTID;








/*Definition 2: U071 with code sets*/
/*Testing: Looking at most popular codes from covid6*/
SELECT *, COUNT(*) as 'Count'
from covid6
WHERE DIAGNOSIS_CD='J10'
GROUP BY DIAGNOSIS_CD
order by DIAGNOSIS_CD;
/*HAVING COUNT(*)=1;*/

/*testing ptid w/ certain set of codes w/ u071*/
SELECT *, COUNT(PTID) as 'Count'
FROM covid6
WHERE DIAGNOSIS_CD='U071' and DIAGNOSIS_CD='Z20822'
having count > 1
ORDER BY PTID;

/*with codes 'Z20822','%R11%','R509', 'Z515','Z20828'*/
CREATE TABLE Def2_TP AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,COUNT(*) as 'Count'
from covid6
where TEST_RESULT = 'POSITIVE' AND (DIAGNOSIS_CD IN ('U071') OR DIAGNOSIS_CD IN ('Z20822','%R11%','R509', 'Z515','Z20828', 'Z1152', 'Z1159'))
group by PTID, RESULT_DATE1, RESULT_TIME_1
ORDER BY PTID;

CREATE TABLE Def2_FN AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,Count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND (DIAGNOSIS_CD IN ('U071') OR DIAGNOSIS_CD IN ('Z20822','%R11%','R509', 'Z515' ,'Z20828'))
group by PTID, RESULT_DATE1, RESULT_TIME_1
ORDER BY PTID;

CREATE TABLE FN2trial AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,Count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND (DIAGNOSIS_CD IN ('U071') OR DIAGNOSIS_CD IN ('Z20822','%R11%','R509', 'Z515' ,'Z20828'))
group by RESULT_DATE1, RESULT_TIME_1, PTID || DIAGNOSIS_CD
ORDER BY PTID;


CREATE TABLE Def2_FP AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'POSITIVE' /*AND DIAGNOSIS_CD<>'U071'*/ AND DIAGNOSIS_CD NOT IN ('U071','Z20822','%R11%','R509', 'Z515','Z20828')
group by PTID, RESULT_DATE1, RESULT_TIME_1
ORDER BY PTID;

CREATE TABLE FP2trial AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'POSITIVE' /*AND DIAGNOSIS_CD<>'U071'*/ AND DIAGNOSIS_CD NOT IN ('U071','Z20822','%R11%','R509', 'Z515','Z20828')
group by RESULT_DATE1, RESULT_TIME_1, PTID || DIAGNOSIS_CD
ORDER BY PTID;


CREATE TABLE TN2 AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' /*AND DIAGNOSIS_CD<>'U071'*/ AND DIAGNOSIS_CD NOT IN ('U071','Z20822','%R11%','R509', 'Z515', 'Z20828')
group by PTID, RESULT_DATE1, RESULT_TIME_1
ORDER BY PTID;


CREATE TABLE TN2trial AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' /*AND DIAGNOSIS_CD<>'U071'*/ AND DIAGNOSIS_CD NOT IN ('U071','Z20822','%R11%','R509', 'Z515', 'Z20828')
group by RESULT_DATE1, RESULT_TIME_1, PTID || DIAGNOSIS_CD
ORDER BY PTID;





/*Different sets of code 'Z20822','Z20828', 'Z11.59', 'Z11.52', 'Z86.16'*/

CREATE TABLE TP3 AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,COUNT(*) as 'Count'
from covid6
where TEST_RESULT = 'POSITIVE' AND (DIAGNOSIS_CD IN ('U071') OR DIAGNOSIS_CD IN ('Z20822','Z20828', 'Z11.59', 'Z11.52', 'Z86.16'))
group by PTID, RESULT_DATE1, RESULT_TIME_1
ORDER BY PTID;

CREATE TABLE FP3 AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,Count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' AND (DIAGNOSIS_CD IN ('U071') OR DIAGNOSIS_CD IN ('Z20822','Z20828', 'Z11.59', 'Z11.52', 'Z86.16'))
group by PTID, RESULT_DATE1, RESULT_TIME_1
ORDER BY PTID;


CREATE TABLE FN3 AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'POSITIVE' /*AND DIAGNOSIS_CD<>'U071'*/ AND DIAGNOSIS_CD NOT IN ('U071','Z20822','Z20828', 'Z11.59', 'Z11.52', 'Z86.16')
group by PTID, RESULT_DATE1, RESULT_TIME_1
ORDER BY PTID;


CREATE TABLE TN3 AS
select PTID
,TEST_RESULT 
,RESULT_DATE1
,RESULT_TIME_1
,diagdate1
,DIAG_TIME_1
,DIAGNOSIS_CD
,count(*) as 'Count'
from covid6
where TEST_RESULT = 'NEGATIVE' /*AND DIAGNOSIS_CD<>'U071'*/ AND DIAGNOSIS_CD NOT IN ('U071','Z20822','Z20828', 'Z11.59', 'Z11.52', 'Z86.16')
group by PTID, RESULT_DATE1, RESULT_TIME_1
ORDER BY PTID;





































/*both years*/
/*a*/
SELECT PTID, ENCID, RESULT_DATE1, RESULT_TIME_1, TEST_RESULT, ENCID_1, diagdate1, DIAG_TIME_1, DIAGNOSIS_CD
FROM covid6
WHERE TEST_RESULT='POSITIVE' AND DIAGNOSIS_CD like '%U071%' 
group by PTID /*|| DIAGNOSIS_CD*/
/*ORDER BY PTID ASC;*/
UNION
/*c*/
SELECT PTID, ENCID, ORDER_TIME, RESULT_DATE1, RESULT_TIME_1, TEST_RESULT, diagdate1, DIAG_TIME_1, DIAGNOSIS_CD
FROM covid6
WHERE TEST_RESULT='NEGATIVE' AND DIAGNOSIS_CD='U071' /*AND PTID='PT205077619' /*AND ENCID<>''/*AND RESULT_DATE LIKE '%2020%' AND DIAG_DATE LIKE '%2020%'*/
/*ORDER BY PTID;*/
UNION
/*d*/
SELECT PTID, ENCID, ORDER_TIME, RESULT_DATE1, RESULT_TIME_1, TEST_RESULT, diagdate1, DIAG_TIME_1, DIAGNOSIS_CD/*, MAX(RESULT_DATE1), COUNT(*) as Count/*, MIN(RESULT_DATE), MIN(RESULT_TIME)*/
FROM covid6
WHERE TEST_RESULT='NEGATIVE' AND DIAGNOSIS_CD <>'U071' /*AND PTID='PT103917389' AND ENCID<>''/*AND RESULT_DATE LIKE '%2020%' AND DIAG_DATE LIKE '%2020%'*/
/*ORDER BY PTID;*/
UNION
/*b*/
SELECT PTID, ENCID, ORDER_TIME, RESULT_DATE1, RESULT_TIME_1, TEST_RESULT, diagdate1, DIAG_TIME_1, DIAGNOSIS_CD/*, MAX(RESULT_DATE1), COUNT(*) as Count/*, MIN(RESULT_TIME)*/
FROM covid6
WHERE TEST_RESULT='POSITIVE' AND DIAGNOSIS_CD IS NOT 'U071'/* AND PTID='PT198460689' /*AND MAX(RESULT_DATE1) /*AND ENCID<>''/*AND RESULT_DATE LIKE '%2020%' AND DIAG_DATE LIKE '%2020%'*/
/*ORDER BY PTID*/
;

/*look at 2020*/
CREATE TABLE covid2020 AS
SELECT *
FROM covid6
WHERE RESULT_DATE1 LIKE '%2020%' /*AND diagdate1 LIKE '%2020%'*/
ORDER BY PTID;

/*2020*/
/*a*/
SELECT PTID, ENCID, ORDER_TIME, RESULT_DATE1, RESULT_TIME_1, TEST_RESULT, POSITIVE, diagdate1, DIAG_TIME_1, DIAGNOSIS_CD
FROM covid2020
WHERE TEST_RESULT='POSITIVE' AND DIAGNOSIS_CD='U071' /*AND ENCID <>''AND RESULT_DATE1 LIKE '%2020%' AND diagdate1 LIKE '%2020%'*/
/*ORDER BY PTID ASC;*/
UNION
/*c*/
SELECT PTID, ENCID, ORDER_TIME, RESULT_DATE1, RESULT_TIME_1, TEST_RESULT, POSITIVE, diagdate1, DIAG_TIME_1, DIAGNOSIS_CD
FROM covid2020
WHERE TEST_RESULT='NEGATIVE' AND DIAGNOSIS_CD='U071' /*AND PTID='PT205077619' /*AND ENCID<>''AND RESULT_DATE1 LIKE '%2020%' AND diagdate1 LIKE '%2020%'*/
/*ORDER BY PTID*/
UNION
/*d*/
SELECT PTID, ENCID, ORDER_TIME, RESULT_DATE1, RESULT_TIME_1, TEST_RESULT, POSITIVE, diagdate1, DIAG_TIME_1, DIAGNOSIS_CD/*, MAX(RESULT_DATE1), COUNT(*) as Count/*, MIN(RESULT_DATE), MIN(RESULT_TIME)*/
FROM covid2020
WHERE TEST_RESULT='NEGATIVE' AND DIAGNOSIS_CD <>'U071'/* AND PTID='PT198460689'/*AND ENCID<>''*/
/*ORDER BY PTID;*/
UNION
/*b*/
SELECT PTID, ENCID, ORDER_TIME, RESULT_DATE1, RESULT_TIME_1, TEST_RESULT, POSITIVE, diagdate1, DIAG_TIME_1, DIAGNOSIS_CD/*, MAX(RESULT_DATE1), COUNT(*) as Count/*, MIN(RESULT_TIME)*/
FROM covid2020
WHERE TEST_RESULT='POSITIVE' AND DIAGNOSIS_CD IS NOT 'U071' /*AND PTID='PT198460689' /*AND MAX(RESULT_DATE1) /*AND ENCID<>''*/
ORDER BY PTID
;

/*look at 2021*/
CREATE TABLE covid2021 AS
SELECT *
FROM covid6
WHERE RESULT_DATE1 LIKE '%2021%' AND diagdate1 LIKE '%2021%'
ORDER BY PTID;

/*2021*/
/*a*/
SELECT *
FROM covid2021
WHERE TEST_RESULT='POSITIVE' AND DIAGNOSIS_CD='U071' /*AND ENCID <>''*/AND RESULT_DATE1 LIKE '%2021%' AND diagdate1 LIKE '%2021%'
/*GROUP BY PTID*/
/*ORDER BY PTID ASC;*/
UNION
/*c*/
SELECT *
FROM covid2021
WHERE TEST_RESULT='NEGATIVE' AND DIAGNOSIS_CD='U071' /*AND PTID='PT205077619' /*AND ENCID<>''*/AND RESULT_DATE1 LIKE '%2021%' AND diagdate1 LIKE '%2021%'
/*ORDER BY PTID;*/
UNION
/*d*/
SELECT */*, MAX(RESULT_DATE1), COUNT(*) as Count/*, MIN(RESULT_DATE), MIN(RESULT_TIME)*/
FROM covid2021
WHERE TEST_RESULT='NEGATIVE' AND DIAGNOSIS_CD <>'U071'/* AND PTID='PT198460689'/*AND ENCID<>''*/AND RESULT_DATE1 LIKE '%2021%' AND diagdate1 LIKE '%2021%'
/*ORDER BY PTID;*/
UNION
/*b*/
SELECT */*, MAX(RESULT_DATE1), COUNT(*) as Count/*, MIN(RESULT_TIME)*/
FROM covid2021
WHERE TEST_RESULT='POSITIVE' AND DIAGNOSIS_CD IS NOT 'U071' /*AND PTID='PT198460689' /*AND MAX(RESULT_DATE1) /*AND ENCID<>''*/AND RESULT_DATE1 LIKE '%2021%' AND diagdate1 LIKE '%2021%'
ORDER BY PTID
;




